---

- name: check reachable hosts
  hosts: all
  gather_facts: no
  tasks:
    - command: ping -c1 {{ inventory_hostname }}
      delegate_to: localhost
      register: ping_result
      ignore_errors: yes
    - group_by: key=reachable
      when: ping_result|success
    - group_by: key=unreachable
      when: ping_result|failure

#- name: Play role on rechable
#  hosts: reachable
#  gather_facts: yes
#  vars_files:
#    - "../env_vars/main.yml"
#  roles:
#    - check

- name: Slack notify on success
  hosts: reachable
  tasks:
    - slack:
      channel: "{{ slack_channel }}"
      color: 'good'
      icon_url: 'https://www.ansible.com/favicon.ico'
      msg: "{{ ansible_hostname }} : UP"
      token: "{{ slack_token }}"
      username: 'Ansible Check'
  run_once: true
  when: slack_notify and
        ping_result|success
  tags:
    - check_notify

- name: Slack notify on failure
  hosts: unreachable
  tasks:
    - slack:
      channel: "{{ slack_channel }}"
      color: 'bad'
      icon_url: 'https://www.ansible.com/favicon.ico'
      msg: "{{ ansible_hostname }} : DOWN"
      token: "{{ slack_token }}"
      username: 'Ansible Check'
  when: slack_notify and
        ping_result|success
  tags:
    - check_notify